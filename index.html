<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>YouTube + Speak Subtitle (iPhone Safari OK)</title>

<style>
body {
margin: 0;
padding: 0;
height: 100vh;
display: flex;
justify-content: center;
align-items: center;
flex-direction: column;
background: #f5f5f5;
font-family: sans-serif;
}

.video-wrapper {
position: relative;
width: 90vw;
max-width: 640px;
aspect-ratio: 16 / 9;
background: #000;
border-radius: 10px;
overflow: hidden;
}

.video-wrapper iframe {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
border: none;
}

#startSpeak {
margin-top: 20px;
padding: 12px 24px;
font-size: 16px;
background: #007aff;
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
}

#startSpeak:active {
opacity: 0.7;
}
</style>
</head>

<body>

<div class="video-wrapper">
<div id="player"></div>
</div>

<button id="startSpeak">Bắt đầu đọc phụ đề</button>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let subtitles = [];
let voicesReady = false;
let userStarted = false;
let lastTime = 0;

// Load phụ đề từ JSON
fetch('Subs/1ivMkhtGq4o.json')
.then(res => res.json())
.then(data => subtitles = data);

// Load voices (iPhone Safari cần onvoiceschanged)
speechSynthesis.onvoiceschanged = () => {
voicesReady = true;
};

// YouTube API
function onYouTubeIframeAPIReady() {
player = new YT.Player('player', {
videoId: '1ivMkhtGq4o',
events: {
'onReady': onPlayerReady,
'onStateChange': onPlayerStateChange
}
});
}

function onPlayerReady(event) {
document.getElementById('startSpeak').addEventListener('click', () => {

userStarted = true;

// Unlock audio trên iPhone
const unlock = new Audio();
unlock.play().catch(()=>{});

// Load voices
speechSynthesis.getVoices();

event.target.playVideo();
speakSubtitles();
});
}

function speak(textdich) {
if (!voicesReady || !userStarted) return;

let utter = new SpeechSynthesisUtterance(textdich);
utter.lang = 'vi-VN';

speechSynthesis.cancel();
speechSynthesis.speak(utter);
}

function speakSubtitles() {
setInterval(() => {
if (!userStarted) return;

let currentTime = player.getCurrentTime();

// Reset toàn bộ phụ đề khi tua theo mọi hướng
if (Math.abs(currentTime - lastTime) > 1.0) {
resetAllSubtitles();
}
lastTime = currentTime;

// Đọc phụ đề
subtitles.forEach(sub => {
if (currentTime >= sub.start && currentTime <= sub.end && !sub.spoken) {
speak(sub.textdich);
sub.spoken = true;
}
});

}, 500);
}

function resetAllSubtitles() {
subtitles.forEach(sub => sub.spoken = false);
speechSynthesis.cancel();
}

function onPlayerStateChange(event) {
if (event.data === YT.PlayerState.PAUSED ||
event.data === YT.PlayerState.BUFFERING) {
resetAllSubtitles();
}
}
</script>

</body>
</html>
