<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>YouTube + Speak Subtitle</title>
</head>
<body>
<div id="player"></div>
<button id="startSpeak">Bắt đầu đọc phụ đề</button>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
let subtitles = [];
let lastTime = 0;

// Load phụ đề từ file JSON
fetch('Subs/1ivMkhtGq4o.json')
.then(res => res.json())
.then(data => subtitles = data);

function onYouTubeIframeAPIReady() {
player = new YT.Player('player', {
height: '360',
width: '640',
videoId: '1ivMkhtGq4o',
events: {
'onReady': onPlayerReady,
'onStateChange': onPlayerStateChange
}
});
}

function onPlayerReady(event) {
document.getElementById('startSpeak').addEventListener('click', () => {
event.target.playVideo();
speakSubtitles();
});
}

function speakSubtitles() {
setInterval(() => {
let currentTime = player.getCurrentTime();

// Kiểm tra tua video theo mọi hướng
if (Math.abs(currentTime - lastTime) > 1.0) {
resetAllSubtitles();
}
lastTime = currentTime;

// Đọc phụ đề
subtitles.forEach(sub => {
if (currentTime >= sub.start && currentTime <= sub.end && !sub.spoken) {
let utter = new SpeechSynthesisUtterance(sub.textdich);
utter.lang = 'vi-VN';
speechSynthesis.cancel();
speechSynthesis.speak(utter);
sub.spoken = true;
}
});
}, 500);
}

// Reset toàn bộ phụ đề
function resetAllSubtitles() {
subtitles.forEach(sub => sub.spoken = false);
speechSynthesis.cancel();
}

function onPlayerStateChange(event) {
// Khi pause hoặc buffering cũng reset để đảm bảo đồng bộ
if (event.data === YT.PlayerState.PAUSED ||
event.data === YT.PlayerState.BUFFERING) {
resetAllSubtitles();
}
}
</script>
</body>
</html>
