<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>YouTube + Speak Subtitle (iPhone Safari OK)</title>

<style>
body {
margin: 0;
padding: 0;
height: 100vh;
display: flex;
justify-content: center;
align-items: center;
flex-direction: column;
background: #f5f5f5;
font-family: sans-serif;
}

.video-wrapper {
position: relative;
width: 90vw;
max-width: 640px;
aspect-ratio: 16 / 9;
background: #000;
border-radius: 10px;
overflow: hidden;
}

.video-wrapper iframe {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
border: none;
}

#startSpeak {
margin-top: 20px;
padding: 12px 24px;
font-size: 16px;
background: #007aff;
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
}

#startSpeak:active {
opacity: 0.7;
}
</style>
</head>

<body>

<div class="video-wrapper">
<div id="player"></div>
</div>

<button id="startSpeak">Bắt đầu đọc phụ đề</button>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let subtitles = [];
let voicesReady = false;
let userStarted = false;
let speakingLoopStarted = false;

// Load subtitles
fetch("Subs/1ivMkhtGq4o.json")
.then(r => r.json())
.then(d => subtitles = d);

// (BƯỚC 2) Load voices – iPhone Safari yêu cầu onvoiceschanged
speechSynthesis.onvoiceschanged = () => {
voicesReady = true;
};

// YouTube API
function onYouTubeIframeAPIReady() {
player = new YT.Player("player", {
videoId: "1ivMkhtGq4o",
events: { onReady: onPlayerReady }
});
}

function onPlayerReady(event) {
document.getElementById("startSpeak").addEventListener("click", () => {

userStarted = true;

// (BƯỚC 1) Unlock audio trên iPhone Safari
const unlock = new Audio();
unlock.play().catch(()=>{});

// Force load voices
speechSynthesis.getVoices();

event.target.playVideo();

// (BƯỚC 4) Start speaking loop bằng requestAnimationFrame
if (!speakingLoopStarted) {
speakingLoopStarted = true;
startSpeakingLoop();
}
});
}

// Speak function
function speak(textdich) {
if (!voicesReady || !userStarted) return;

let u = new SpeechSynthesisUtterance(textdich);
u.lang = "vi-VN";

speechSynthesis.cancel();
speechSynthesis.speak(u);
}

// LOOP chạy bằng requestAnimationFrame (iPhone cho phép)
function startSpeakingLoop() {
function loop() {
let t = player.getCurrentTime();

subtitles.forEach(sub => {
if (t >= sub.start && t <= sub.end && !sub.spoken) {
sub.spoken = true;
speak(sub.textdich);
}
});

requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
}
</script>

</body>
</html>
