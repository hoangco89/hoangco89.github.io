<!DOCTYPE html>
<html lang="en">
<!--
#https://github.com/hoangco89/hoangco89.github.io/index.html
#tai xuong 15-01-26
-->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Import SweetAlert2 -->
  <title>Preparing to settle in the US</title>

  <style>
    body {
      height: 100%;
      background-image: linear-gradient(-45deg, gray, grey);
      color: #fff;
      font: 1rem/1 'Poppins', sans-serif;
      max-width: 800px;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
      background-size: cover;
      background-position: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
      /* ho·∫∑c margin: 0 auto; 
      margin-bottom: 100%;*/

    }

    .video-container {
      position: relative;
      width: 100%;
      min-width: 100%;
      /* √©p kh√¥ng co l·∫°i */
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      background: #000;
    }

    iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: block;
      /* tr√°nh Safari th√™m kho·∫£ng tr·∫Øng */
    }

    .menu-group {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      padding: 0 0;
      width: 100%;
      box-sizing: border-box;
    }
    .butp1,.butp2{
    font-size: 1.4rem;
    }
    #voiceSelect{
    color:darkgreen;
    width: 30%; 
    display: block;
    margin-left: 0;
    font-size: 1.4rem;
    }
    #rateRead{
    font-size: 1.4rem;
    }
#selectChude {
  color:rgb(2, 78, 2);
  width: 75%; 
  display: block;
  margin-left: auto;
  margin-right: auto; /* ho·∫∑c margin: 0 auto; */
  font-size: 1.1rem;
  background-color: gainsboro;
  color:darkgreen;
}
#videoSelect {
  width: 75%; 
  display: block;
  margin-left: auto;
  margin-right: auto; /* ho·∫∑c margin: 0 auto; */
  font-size: 1.1rem;
  color:darkblue;}


h4{
  font-weight:bolder;
  font-size: 1.2rem;
  margin-left:20px;
  color:rgb(223, 231, 223);
  width: 75%; 
}
h5{
  display: block;
  margin-left: auto;
  margin-right: auto;
  font-size: 1.1rem;
  color:rgb(193, 193, 239);
  width: 75%; 
}
h5{
  text-align: center;
}
   #voiceSelect, #rateRead,.butp1,.butp2,#playBtn{
    width: 19%;
    font-size: 0.9rem;
    }
    #currentSubtitle{
    text-align: right;
    font-size: 1.2rem;
    height:2rem;
    color:rgb(193, 193, 239);
    overflow-y: auto;
    }
    
    #subdich{
    text-align: left;
      color:antiquewhite;
    font-size: 1.4rem;
    height:3rem;
    margin-left:10px;
    font-style: italic;
    overflow-y: auto;
    }

    #playBtn{
    color:darkblue;
    font-weight:bolder;
    font-size: 1.1rem;
    }

    #loa_button{
    margin-left:10px;
    margin-bottom:4px;
    }
    .outiframe{
    margin-bottom:100%;
    }
#tbao{
  display: block;
  margin: 0 auto;
  width:50%;
  background-color: transparent;
  border:transparent;
  height: 20px;
}
#inputurl{
  width: 75%; 
  display: block;
  margin-left: auto;
  margin-right: auto; /* ho·∫∑c margin: 0 auto; */
  font-size: 1.1rem;
  color: darkblue;
  background-color: gainsboro;
}
#OK{
  display: block;
  margin-left: auto;
  margin-right: auto; /* ho·∫∑c margin: 0 auto; */
  font-size: 1.2rem;
  color:darkgreen;
  width: 20%; 

}
#radio-container{
  margin-left:40px;
  color:darkblue;
  width: 75%; 
}
#radio-container label {
  display: block;
  padding: 4px 0;      /* tƒÉng kho·∫£ng c√°ch tr√™n/d∆∞·ªõi */
}
#videochon{
  color:rgb(231, 225, 225);
  text-align: center;
}
</style>
</head>

<body>

    <div class="video-container">
      <div id="playerContainer"></div>
    </div>

    <div class="menu-group">
      <select id="voiceSelect"></select>
      <button id='rateRead' onclick="tocDoDoc()">Rate: 1</button>

      <button id="playBtn">‚ñ∂Ô∏è</button>

      <button class='butp1' onclick="btnReadSub()">Sub only</button>
      <button class='butp2' onclick="btnYoutubeSound()">Ytu only</button>
    </div>
    <hr>

    <div class='outiframe'>
      <br>
      <div id="currentSubtitle">[source subtitles]</div>
      <div id="loa_button">üîä</div>
      <div id="subdich">[translated subtitles ]</div>
      <br>
      <hr>
      <div id="videochon" onclick="them_Http()">JqJ7PlMCDuE</div>
      <div id="videochon_http"></div>
      <hr>

      <h5>Ch·ªçn video :</h5>
      <select id="videoSelect"></select>
      <button id="tbao" onclick="stlay_json_cde1()"></button>

      <h4>1. Ch·ªçn Ch·ªß ƒë·ªÅ :</h4>
      <select id="selectChude"></select>

      <h4>2. Nh·∫≠p Yt Url :</h4>
      <input type="text" id="inputurl" placeholder="Enter a youtube url">
      <br><button id="OK" onclick="xuLiUrlInput()">Submit</button><br>
      

      <!--<h4><a href="https://tien89.streamlit.app" style="background: transparent;text-align: center; ">.</a></h4>-->
      <h4><a href="z.py" style="background: transparent;text-align: center; ">.</a></h4>
    </div>
    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
      var rateVread = 1;
      var utterance_volume = 1;
      const videochon = document.getElementById("videochon");
      videochon.textContent = 'JqJ7PlMCDuE'; //default
      const videoSelect = document.getElementById("videoSelect");
      const selectChude = document.getElementById("selectChude");

      // ==========================
      // 1. LOAD VOICES
      // ==========================
      const voiceSelect = document.getElementById("voiceSelect");
      let voices = [];

      function loadVoices() {
        voices = speechSynthesis.getVoices();
        if (!voices.length) return;

        voiceSelect.innerHTML = "";
        voices.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.name;
          opt.textContent = `${v.lang} ${v.name}`;
          voiceSelect.appendChild(opt);
        });
        for (let opt of voiceSelect.options) {
          if (opt.textContent.includes("vi-VN") && (opt.value.includes("An") || opt.value.includes("Linh"))) {
            voiceSelect.value = opt.value;   // ch·ªçn option ƒë√≥
            break;                      // d·ª´ng l·∫°i ngay
          }
        }

      }

      speechSynthesis.onvoiceschanged = loadVoices;
      loadVoices();





      // ==========================
      // 2. YOUTUBE PLAYER
      // ==========================
      let player = null;

      function onYouTubeIframeAPIReady() {
        player = new YT.Player("playerContainer", {
          height: "315",
          width: "560",
          videoId: videochon.textContent, //`${id_video}`
          playerVars: { autoplay: 0, controls: 1 },
          events: {
            onReady: () => { },
            onStateChange: (e) => {
              if (e.data === YT.PlayerState.PAUSED) stopReading();
              if (e.data === YT.PlayerState.PLAYING) resumeSync();
              if (e.data === YT.PlayerState.ENDED) stopReading();
            }
          }
        });
      }
      window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

      // ==========================
      // 3. FETCH JSON SUBTITLES
      // ==========================
      async function fetchSubtitles(videoId) {
        const url = `Subs/${videoId}.json`;

        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y JSON");
          return await res.json();
        } catch (err) {
          console.error(err);
          return [];
        }
      }

      // ==========================
      // 4. TTS + SYNC SUBTITLES
      // ==========================
      let subtitles = [];
      let interval = null;
      let currentIndex = -1;
      const subDiv = document.getElementById("currentSubtitle");

      function speak(textd) {
        speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(textd);
        utter.rate = rateVread;
        const selected = voiceSelect.value;
        const voice = voices.find(v => v.name === selected);
        if (voice) utter.voice = voice;
        loa_button.onclick = () => {
          utter.volume = utterance_volume;
          speechSynthesis.speak(utter);
        }
        loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n
      }

      function stopReading() {
        speechSynthesis.cancel();
        clearInterval(interval);
        interval = null;
        currentIndex = -1;
      }

      function resumeSync() {
        stopReading();
        startSync();
      }

      function startSync() {
        interval = setInterval(() => {
          if (!player || !subtitles.length) return;

          const t = player.getCurrentTime();
          let idx = subtitles.findIndex(s => t >= s.start && t < s.end);

          if (idx !== currentIndex) {
            currentIndex = idx;

            if (idx === -1) {
              subDiv.textContent = "";
            } else {
              document.getElementById("currentSubtitle").textContent = subtitles[idx].text;
              document.getElementById("subdich").textContent = subtitles[idx].textdich;
              speak(subtitles[idx].textdich);
            }
          }
        }, 200);
      }

      // ==========================
      // 5. PLAY BUTTON
      // ==========================
      document.getElementById("playBtn").addEventListener("click", async () => {
        const videoId = videochon.textContent;

        subtitles = await fetchSubtitles(videoId);

        // üî• D·ªäCH TO√ÄN B·ªò JSON
        translateFullJson(subtitles);

        player.loadVideoById(videoId);
        player.playVideo();

        startSync();
      });


      // ==========================
      // 6. AUTO PLAY WHEN CHANGE VIDEO
      // ==========================
      videoSelect.addEventListener("change", async () => {
        localStorage.setItem("selectedVideoId", videoSelect.value);

        videochon.textContent = videoSelect.value;
        const videoId = videochon.textContent;

        subtitles = await fetchSubtitles(videoId);

        // üî• D·ªäCH TO√ÄN B·ªò JSON
        translateFullJson(subtitles);

        player.loadVideoById(videoId);
        player.playVideo();

        startSync();

      });





      //---dich
      function translateFullJson() {
        const selected = voiceSelect.value;
        const v = voices.find(x => x.name === selected);

        let sourceLanguage = 'en';
        let targetLanguage = v.lang.split("-")[0];
        //console.log(sourceLanguage, targetLanguage);
        //tao texts la list chua cac text cua subtitles
        let texts = subtitles.map(item => item.text);
        let textdichs = subtitles.map(item => item.textdich);

        //console.log(texts);

        Array.prototype.forEach.call(texts, function (cau, i) {
          let inputText = cau;
          let outputTextEle = textdichs[i];

          const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

          const xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
              const responseReturned = JSON.parse(this.responseText);
              const translations = responseReturned[0].map((text) => text[0]);
              const outputText = translations.join(" ");
              //outputTextEle.textdich = outputText;
              subtitles[i].textdich = outputText;
              console.log(subtitles[i].textdich);
            }
          };
          //---------------------
          xhttp.open("GET", url);
          xhttp.send();
        });
      }
      const rateRead = document.getElementById('rateRead');
      function tocDoDoc() {
        let rateReadValue = Number(rateRead.textContent.split(':')[1]);
        rateReadValue = (1 + rateReadValue) % 10;//1,2,3,4,5,0
        if (rateReadValue == 0) rateReadValue = 1;
        rateRead.textContent = 'Rate: ' + rateReadValue;
        rateVread = 1 + rateReadValue / 10;//1, 1.5, 2, 2.5, 3, 3.5
      }

      function btnReadSub() {
        // T·∫Øt ti·∫øng YouTube
        if (player && player.mute) {
          player.mute();
        }
        // B·∫≠t √¢m l∆∞·ª£ng ƒë·ªçc ph·ª• ƒë·ªÅ
        utterance_volume = 1;
      }

      function btnYoutubeSound() {
        // B·∫≠t ti·∫øng YouTube
        if (player && player.unMute) {
          player.unMute();
          player.setVolume(100);
        }
        // T·∫Øt √¢m l∆∞·ª£ng ƒë·ªçc ph·ª• ƒë·ªÅ
        utterance_volume = 0;
      }



      function them_Http() {
        document.getElementById("videochon_http").innerHTML = 'https://www.youtube.com/watch?v=' + videochon.textContent;
      }

          //moi khi chay lai trang thi khoi phuc  voice + video
    
        //ham gui https// da nhap toi streamlit dang chay
  
    </script>


    <script src="index.js"></script>
</body>

</html>
