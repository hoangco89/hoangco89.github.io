<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Import SweetAlert2 -->
    <title>Chat in multiple languages</title>
<style>
body{
height:100%;
background-image: linear-gradient(30deg, #1666b0, #fbfafb); 
color: #fff;
font: 1rem/1 'Poppins', sans-serif;
max-width: 800px;
flex-direction: column;
padding-bottom: env(safe-area-inset-bottom);
background-size: cover;
background-position: center;
display: block;
margin-left: auto;
margin-right: auto; /* ho·∫∑c margin: 0 auto; */
margin-bottom: 100%;
}
.video-container {
  position: relative;
  width: 100%;
  min-width: 100%;      /* √©p kh√¥ng co l·∫°i */
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  background: #000;
}
iframe { 
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: block;       /* tr√°nh Safari th√™m kho·∫£ng tr·∫Øng */
}
.menu-group {
  margin-top: 4px;  
  display: flex;
  justify-content: space-between;
  padding: 0 0 ; 
  width: 100%;
  box-sizing: border-box;
}
.butp1,.butp2{
  font-size: 1.4rem;

}
#voiceSelect{
  color:darkgreen;
  width: 30%; 
      display: block;
    margin-left: 0;
  font-size: 1.4rem;
}
#videoSelect,#videoSelectqtmy,#videoSelectlsmy {
  color:rgb(2, 78, 2);
  width: 75%; 
      display: block;
    margin-left: auto;
    margin-right: auto; /* ho·∫∑c margin: 0 auto; */
  font-size: 1.1rem;
  color:gray;
}
#rateRead{
  font-size: 1.4rem;

}

#voiceSelect,#rateRead,.butp1,.butp2,#playBtn{
  width: 19%;
  font-size: 0.9rem;
}

#currentSubtitle{
  text-align: right;
  font-size: 1.4rem;
  color: darkgreen;
}
#subdich{
  text-align: left;
  color: darkblue;
  font-size: 1.6rem;
}
#playBtn{
background-color: transparent;
color:darkblue;
  font-weight:bolder;
  font-size: 1.2rem;

}
h3{
  font-weight:bolder;
  font-size: 1.5rem;
    margin-left:20px;
    color:darkslategray;
}
#currentSubtitle{
    height:3rem;
    margin-right: 10px;
}
#subdich{
    height:4rem;
    margin-left:10px;
}
</style>
</head>
<body>
    <div class="video-container">

        <div id="playerContainer"></div>

    </div>

    
    <div class="menu-group">
        <select id="voiceSelect" ></select>
        <button id='rateRead' onclick="tocDoDoc()">Rate: 1</button>

        <button id="playBtn">START ‚ñ∂Ô∏è</button>

        <button class='butp1' onclick="btnReadSub()">Read sub only</button>
        <button class='butp2' onclick="btnYoutubeSound()">Sound yt only</button>
        

    </div>
    <hr>
    <div class='outiframe'>
        <br>
        
        <div id="currentSubtitle">[source subtitles]</div>
        <div id="loa_button">üîä</div>
        <div id="subdich">[translated subtitles ]</div>
        <br>
        <hr>
        <h3>1. Video hoc lai xe:</h3>
        <select id="videoSelect" ></select>
        <h3>2. Video ve lich su Hoa Ky:</h3>
        <select id="videoSelectlsmy" ></select>
        <h3>3. Video test thi qt My:</h3>
        <select id="videoSelectqtmy" ></select>
    </div>

  <!-- YouTube API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
var rateVread = 1;
var utterance_volume=1;
// ==========================
    // 0. TAO MENU VDEO_ID
    // ==========================

    let listIdTd = [
"CCCUTqJ3dBA|001: Learn How to Drive",
"ud8tM2OXcmY|002: Learn How to Drive Car Controls",
"ippjq7-QMS8|003: How to Drive a Car in a Straight Line",
"F3lIyv20Y54|004: How To Control The Gas and Brake Pedals",
"l2Vq6KkLolY|005: LEARN HOW TO MERGE  onto Highway Safely",
"2cjcJv2G_qg|006: How To Pass Your Driver‚Äôs Test",
"i-khzo9ApcY|007: How To Do a Three Point Turn",
"icLfRpbFdGE|008: To Control Gas & Brake Pedal in a CAR",
"W1FISN536HY|009: Techniques to Pass Your Road Test First Time",
"5ojncFo1HNk|010: Learning to Drive a Car",
"iF5wZnNPEIw|011: Park in Reverse",
"9f4ioms-7Uc|012: What to Practice/Where to Start",
"P2jdHup_vlY|013: How to Drive in a Straight Line",
"ORuPdMPLz9Y|014: How To Change Lanes",
"RNeRrcpmTF0|015: How to Pass Your Drivers Exam",
"kXxEMuhr1sw|016: Learn How to Parallel Park",
"N4JWp2YKQqo|017: IMPORTANT POINT IN THE DRIVING ROAD TEST",
"gu1KKcyKSmI|018: First Time Behind the Wheel",
"Ss6Gtpd5lVs|019: NEW 2023 Driving Test",
"T9f1Rt3N87g|020: The Secret To Making Perfect Turns While Driving",
"A5QkPbBKLlI|021: Master the Basics",
"0Ni9trBmLq4|022: Top Mistakes to Avoid and Pass Your Driving Exam",
"Ukk8s44BvZc|023: Lane Change Made Easy",
"mkDQRVruJ9c|024: How To Change Lanes",
"vmP_nQbmuPs|025: How to Exit Parking Spaces Like a Pro",
"oq0SB8mXErw|026: How To Stay Centered in Your Lane",
"bCYWfsVRl0c|027: How To Use Your Mirrors",
"VKD4LjLV0tw|028: Reverse Parking",
"5r87CvbrsAo|029: Lane Change Techniques: A Must-Watch Tutorial",
"5DYuuV9FQzo|030: First Time Behind the Wheel",
"kvuUSpZU44A|031: The DMV Test Guide",
"8Vt3z2UH1jI|032: Ace Your Written Driving Test!",
"PuFFijGgP7E|033: Mistakes To Avoid If You Want To Pass Your Road",
"RTvywSBGzgo|034: How To Obtain Your Driver's License",
"qE46UxUOv4c|035: The 10 Must-Knows for Beginners-Essential Tips",
"o_Fvye2NWGw|036: Unlock Your Confidence: *Top Tips Revealed*",
"Hkgsc4Wu28Q|037: Crush Your Parallel Parking Like a Boss!",
"tGfLZGAk_sQ|038: Learn To Reverse Out of a Parking Space",
"Ld-uWn2Mf3A|039: 3-Point Turns on Your Road Test!",
"oB0kP5ilvts|040: How To Make Turns and Control The Steering Wheel",
"TAoc4ZP_Y1M|041: How To Pass Your Driving Exam",
"1ivMkhtGq4o|042: How To Drive On The Highway: Merging Techniques",
"B6KVfzWt6EY|043: Learn to Drive Stick",
"Uv1xCITxIxM|044: Lane-Keeping Tips for New Drivers",
"LSv10gVeiCA|045: Navigating Your Car's Controls for Beginners",
"vy6R-PxbLeQ|046: The Ultimate Traffic Sign Tutorial",
"JgObYyIWMwA|047: What You Need To Know Before You Drive!",
"PTSonLCKWu4|048: Your Road Test Survival Guide",
"0e4JjNryU90|049: Overcoming Fear as a Beginner Driver",
"HWzD4RnUvMk|050: Learn How to Park",
"YhvWXhZOMfQ|051: Driving for the First Time: Step-by-Step Tutorial",
"E2uXiQ91m2k|052: Mistakes That Will Fail Your Driving Test",
"oYALXa3Y9I0|053: How to Accelerate and Brake Smoothly",
"EpGlJxRlrgc|054: How To Make Turns",
"QBxFs5Ms6Q4|055: Your First Time on the Highway",
"yYL9cvZWRUI|056: Overcoming Driving Anxiety Fast",
"pyTHd_DP15o|057: Pass The Road Test",
"vn743_v_tyU|058: Driver's License 101",
"6yOLoyq93BA|059: How to Handle Your First Drive in Traffic",
"3A3RgJkojQY|060: 3-Point Turn Made Easy",
"7XGwwH5ZgxA|061: What to Do When Pulled Over",
"bA-VPf7eQ8A|062: How to Use Your Mirrors",
"JC-VPFa2ox8|063: DMV Written Test Prep",
"QS2Miq5m9N8|064: Parking For The First Time",
"nKAWIhmoocY|065: Parallel Parking For The First Time",
"MfKz5nKMI9M|066: How to Reverse Park Your Car",
"-jxdQTSEXEo|067: Road Signs & Signals",
"aVKM2Z9eePM|068: Your First Driving Lesson",
"OaQEsDScaBU|069: Driving in Traffic For The First Time",
"SxtqKhiZvFA|070: How to Pass Your Road Test First Time",
"E4-_s2Tbz4Q|071: Top 5 Mistakes That Fail Your Driving",
"3gkcKYViKkc|072: Straight Parking 101",
"6j83BCu7CGs|073: Easy 3-Point Turn",
"rGIFKjNtugw|074: How To Make Turns",
"xFUiVnPT-e8|075: How To Make Turns for Drivers",
"3P5lLbdOEE0|076: Go From Zero to Confident Driver",
"GkKjHCtunes|077: Parallel Parking: The EASIEST Way Ever!",
"y_vH9OyP5zs|078: Lane Changing for Beginners",
"nHcG4_eTmMg|079: How to Drive On The Highway",
"CZXU-CRPCKs|080: Must-Know Reversing Tips to Pass Your Driving",
"f4jcZshsmVU|081: Is Tesla the Best Electric Car",
"0znTbKmCRz4|082: How to Get ROAD TEST READY in 24 Hours!",
"Y_HcH6BSK60|083: How to Stay in Your Lane",
"tWQ5xYNnJtM|084: Use Pedals, Adjust Seat, & Set Mirrors!",
"EMCzxnhc6PQ|085: PASS your Driving avoiding these mistakes!",
"Dvpw0XbsPBU|086: Road Sign and Street Signal You Need to Know!",
"OPjrBtX1e2M|087: ROAD TEST DAY",
"H_4blrvHvhI|088: How to Exit a Parking Space",
"boAHA39qXpI|089: How To Park a Car",
"Pke1Ix4A7Ms|090: How To Turn The Steering Wheel",
"kF4SbzZiPBQ|091: CDL PRACTICE TEST 2025: Pre-Trip Inspection",
"bpC3FR-Vidg|092: CDL PRACTICE TEST 2025: Hazmat Endorsement",
"mm6w3ccNxb4|093: Three-Point Turn Tutorial",
"MW1tr5j3zPA|094: Gas and Brake Control",
"EXzcsEv_jZg|095: How to Pass Your Road Test",
"cRUWI4ErLQU|096: Overcoming Driving Anxiety",
"70zPW7t5_eQ|097: How to Get Your Driver's License",
"jt5zc8EYRGc|098: Your Last Minute GUIDE to pass!",
"l4Z13XGxFlA|099: Learn Traffic Signs & Street Markings",
"tpYM_xaTsOA|100: How To Use Your Vehicle's Blind Spots",
"MCYf0C88XdQ|101: B·ªô ƒë·ªÅ s·ªë 1",
"evOX9f2Mfcc|102: 100 Important Road Signs with their Meanings",
"uZz8tcItyv8|01: USCIS 128 Civics Questions and SIMPLE Answers Repeat 2X",
"f3Axko3ZALg|02: 128 Civics Questions and answers RANDOM Order 2X",
"DV531IM4WZw|03: USCIS 128 Civics Questions and SIMPLE Answers in RANDOM ORDER",
"JwpxncI-ILg|04: USCIS 2008 and 2025 Civics Tests ‚Äî ALL Questions in One Video!",
"burAsJLxM9k|05: DON'T SAY THESE PHRASES during your N-400 Interview",
"Zzt1Wk_117A|06: 2025 N400 English Reading and Writing Test Sentences",
"dA_zVI1-_Ak|07: N400 50 English Writing Test Sentences",
"xaRqw0icVbo|08: 2025 N-400 Part 9 Vocabulary Definitions",
"yiXOr9kQVnM|09: N400 Part 9 40+ MOST ASKED N400 VOCABULARY",
"8KF6Yo9Jkso|10: 2025 N-400 Part 9 Word Definitions & Questions",
"uBf-PsKSkUU|11: NEW N-400 Interview",
"wKt2hLQqhQQ|12: N-400 Interview",
"I21BOVXaPC4|13: US Citizenship Interview",
"iokZB8Y52aE|14: How to Apply for a US Passport for the 1st Time",
"SkG2TSOBLzI|15: Things you NEED to do after becom a US Citizen"
];
    //tao list videos chua cac thong tin id, subtitle, title
    const videos = listIdTd.map(item => {
    const [id, title] = item.split("|");
    return {
        id: id,
        subtitle: `${id}.json`,
        title: title.trim()
    };
    });

    //tao menu chon video (select_id)
    videos.forEach((v, index) => {
    const option = document.createElement("option");
    option.value = v.id;
    option.textContent = v.title;
    videoSelect.appendChild(option);
    });

    // ==========================
    // 1. LOAD VOICES
    // ==========================
    const voiceSelect = document.getElementById("voiceSelect");
    let voices = [];

    function loadVoices() {
      voices = speechSynthesis.getVoices();
      if (!voices.length) return;

      voiceSelect.innerHTML = "";
      voices.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.name;
        opt.textContent = `${v.lang} ${v.name}`;
        voiceSelect.appendChild(opt);
      });
    }

    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

//ham khoi phuc 
function restoreSelections() {
  const savedVideo = localStorage.getItem("selectedVideoId");
  const savedVoice = localStorage.getItem("selectedVoiceName");
  // Kh√¥i ph·ª•c video
  if (savedVideo) {
    videoSelect.value = savedVideo;
  }
  // Kh√¥i ph·ª•c voice
  if (savedVoice) {
    const check = voices.find(v => v.name === savedVoice);
    if (check) voiceSelect.value = savedVoice;
  }
}

//moi khi voice thay doi thi khoi phuc da luu
speechSynthesis.onvoiceschanged = () => {
  loadVoices();
  restoreSelections();   // üî• kh√¥i ph·ª•c voice + video
};

    // ==========================
    // 2. YOUTUBE PLAYER
    // ==========================
    let player = null;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player("playerContainer", {
        height: "315",
        width: "560",
        videoId: document.getElementById("videoSelect").value,
        playerVars: { autoplay: 0, controls: 1 },
        events: {
          onReady: () => {},
          onStateChange: (e) => {
            if (e.data === YT.PlayerState.PAUSED) stopReading();
            if (e.data === YT.PlayerState.PLAYING) resumeSync();
            if (e.data === YT.PlayerState.ENDED) stopReading();
          }
        }
      });
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    // ==========================
    // 3. FETCH JSON SUBTITLES
    // ==========================
    async function fetchSubtitles(videoId) {
      const url = `Subs/${videoId}.json`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y JSON");
        return await res.json();
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    // ==========================
    // 4. TTS + SYNC SUBTITLES
    // ==========================
    let subtitles = [];
    let interval = null;
    let currentIndex = -1;
    const subDiv = document.getElementById("currentSubtitle");

    function speak(textd) {
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(textd);
      utter.rate = rateVread;
      const selected = voiceSelect.value;
      const voice = voices.find(v => v.name === selected);
      if (voice) utter.voice = voice;
      loa_button.onclick = () => {
        utter.volume = utterance_volume;
        speechSynthesis.speak(utter);
      }
      loa_button.click(); // t·ª± ƒë·ªông ph√°t lu√¥n
   }

    function stopReading() {
      speechSynthesis.cancel();
      clearInterval(interval);
      interval = null;
      currentIndex = -1;
    }

    function resumeSync() {
      stopReading();
      startSync();
    }

    function startSync() {
      interval = setInterval(() => {
        if (!player || !subtitles.length) return;

        const t = player.getCurrentTime();
        let idx = subtitles.findIndex(s => t >= s.start && t < s.end);

        if (idx !== currentIndex) {
          currentIndex = idx;

          if (idx === -1) {
            subDiv.textContent = "";
          } else {
            document.getElementById("currentSubtitle").textContent = subtitles[idx].text;
            document.getElementById("subdich").textContent = subtitles[idx].textdich;
            speak(subtitles[idx].textdich);
          }
        }
      }, 200);
    }

    // ==========================
    // 5. PLAY BUTTON
    // ==========================
document.getElementById("playBtn").addEventListener("click", async () => {
  const videoId = document.getElementById("videoSelect").value;

  subtitles = await fetchSubtitles(videoId);

  // üî• D·ªäCH TO√ÄN B·ªò JSON
  translateFullJson(subtitles);

  player.loadVideoById(videoId);
  player.playVideo();

  startSync();
});


    // ==========================
    // 6. AUTO PLAY WHEN CHANGE VIDEO
    // ==========================
document.getElementById("videoSelect").addEventListener("change", async () => {
    localStorage.setItem("selectedVideoId", videoSelect.value);
    const videoId = videoSelect.value;

    subtitles = await fetchSubtitles(videoId);

    // üî• D·ªäCH TO√ÄN B·ªò JSON
    translateFullJson(subtitles);

    player.loadVideoById(videoId);
    player.playVideo();

    startSync();

  });

//moi lan thay doi voice thi dich lai
document.getElementById("voiceSelect").addEventListener("change", async () => {
    //
    localStorage.setItem("selectedVoiceName", voiceSelect.value);
    translateFullJson(subtitles);
    startSync();
});




//---dich
function translateFullJson(){
    const selected = voiceSelect.value;
    const v = voices.find(x => x.name === selected);

    let sourceLanguage = 'en';
    let targetLanguage = v.lang.split("-")[0];
    //console.log(sourceLanguage, targetLanguage);
    //tao texts la list chua cac text cua subtitles
    let texts = subtitles.map(item => item.text);
    let textdichs = subtitles.map(item => item.textdich);

    //console.log(texts);
    
    Array.prototype.forEach.call(texts, function(cau,i) {
        let inputText = cau;
        let outputTextEle = textdichs[i];

        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLanguage}&tl=${targetLanguage}&dt=t&q=${encodeURI(inputText)}`;

        const xhttp = new XMLHttpRequest();  
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200){
                const responseReturned = JSON.parse(this.responseText);
                const translations = responseReturned[0].map((text) => text[0]);
                const outputText = translations.join(" ");
                //outputTextEle.textdich = outputText;
                subtitles[i].textdich = outputText;
                console.log(subtitles[i].textdich);
            }
        };
        //---------------------
        xhttp.open("GET", url);
        xhttp.send();
    });
}
const rateRead = document.getElementById('rateRead');
function tocDoDoc(){
  let rateReadValue = Number(rateRead.textContent.split(':')[1]);
  rateReadValue = (1+rateReadValue)%10;//1,2,3,4,5,0
  if (rateReadValue==0) rateReadValue=1;
  rateRead.textContent = 'Rate: '+ rateReadValue;
  rateVread = 1+rateReadValue/10;//1, 1.5, 2, 2.5, 3, 3.5
}

function btnReadSub() {
  // T·∫Øt ti·∫øng YouTube
  if (player && player.mute) {
    player.mute();
  }
  // B·∫≠t √¢m l∆∞·ª£ng ƒë·ªçc ph·ª• ƒë·ªÅ
  utterance_volume = 1;
}

function btnYoutubeSound(){
  // B·∫≠t ti·∫øng YouTube
  if (player && player.unMute) {
    player.unMute();
    player.setVolume(100);
  }
  // T·∫Øt √¢m l∆∞·ª£ng ƒë·ªçc ph·ª• ƒë·ªÅ
  utterance_volume = 0;
}


//moi khi chay lai trang thi khoi phuc  voice + video
restoreSelections();   // üî• kh√¥i ph·ª•c voice + video

</script>



</body>
</html>
