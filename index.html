<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Phá»¥ Ä‘á» tá»«ng dÃ²ng</title>
  <style>
    #subtitle { margin-top: 20px; font-size: 20px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ¬ Chá»n video</h2>
  <select id="videoSelector">
    <option value="0">Video 1</option>
    <option value="1">Video 2</option>
    <option value="2">Video 3</option>
    <option value="3">Video 4</option>
    <option value="4">Video 5</option>
  </select>

  <div id="player"></div>

  <div id="subtitle"></div>

  <button onclick="speakCurrent('en')">ğŸ”Š Äá»c tiáº¿ng Anh</button>
  <button onclick="speakCurrent('vi')">ğŸ”Š Äá»c tiáº¿ng Viá»‡t</button>

  <script>
    const videoIds = ["CCCUTqJ3dBA", "ud8tM2OXcmY", "ippjq7-QMS8"];
    const subtitleFiles = ["Subs/CCCUTqJ3dBA.json", "Subs/ud8tM2OXcmY.json", "Subs/ippjq7-QMS8.json"];

    let currentSubtitles = [];
    let currentLine = null;
    let player;

    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      loadVideo(0);
    }

    function loadVideo(index) {
      const videoId = videoIds[index];
      const subtitleFile = subtitleFiles[index];

      if (player) {
        player.loadVideoById(videoId);
      } else {
        player = new YT.Player('player', {
          height: '315',
          width: '560',
          videoId: videoId,
          events: {
            'onStateChange': onPlayerStateChange
          }
        });
      }

      fetch(subtitleFile)
        .then(res => res.json())
        .then(data => {
          currentSubtitles = data;
          document.getElementById("subtitle").innerHTML = "â³ Äang phÃ¡t...";
        });
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) {
        startSync();
      } else {
        clearInterval(window.syncInterval);
      }
    }

    function startSync() {
      clearInterval(window.syncInterval);
      window.syncInterval = setInterval(() => {
        const time = player.getCurrentTime();
        updateSubtitle(time);
      }, 500);
    }

    function updateSubtitle(currentTime) {
      const match = currentSubtitles.find(s => currentTime >= s.start && currentTime <= s.end);
      if (match && match !== currentLine) {
        currentLine = match;
        //document.getElementById("subtitle").innerHTML = `<strong>EN:</strong> ${match.text}<br><strong>VI:</strong> ${match.textdich}`;
        document.getElementById("subtitle").innerText = `${match.textdich}`;
        let txtvi = document.getElementById("subtitle").innerText;
        //console.log(`${match.textdich}`);
        speakCurrent(txtvi);
      }
    }

    function speakCurrent(text) {
        const utter = new SpeechSynthesisUtterance(text);
            function speak(lang) {
    speechSynthesis.cancel(); // Dá»«ng má»i giá»ng Ä‘ang Ä‘á»c

    const voices = speechSynthesis.getVoices();
    const utterance = new SpeechSynthesisUtterance();
    utterance.lang = lang === "en" ? "en-US" : "vi-VN";
    utterance.text = currentSubtitles.map(s => s[lang]).join(". ");

    // TÃ¬m giá»ng phÃ¹ há»£p
    const matchedVoice = voices.find(v => v.lang.startsWith(utterance.lang));
    if (matchedVoice) {
        utterance.voice = matchedVoice;
    } else {
        alert("KhÃ´ng tÃ¬m tháº¥y giá»ng Ä‘á»c phÃ¹ há»£p cho " + utterance.lang);
    }

    speechSynthesis.speak(utterance);
    }


    // Äáº£m báº£o danh sÃ¡ch voice Ä‘Æ°á»£c táº£i Ä‘áº§y Ä‘á»§
    if (typeof speechSynthesis !== "undefined" && speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = () => {
        speechSynthesis.getVoices(); // KÃ­ch hoáº¡t táº£i voice
    };
    }

        utter.lang = "vi-VN";
        utter.rate = 1.6;
        speechSynthesis.cancel(); // Dá»«ng náº¿u Ä‘ang nÃ³i
        speechSynthesis.speak(utter);
    }

    document.getElementById("videoSelector").addEventListener("change", (e) => {
      loadVideo(e.target.value);
    });

    // Khá»Ÿi Ä‘á»™ng danh sÃ¡ch voice
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }
  </script>
</body>
</html>