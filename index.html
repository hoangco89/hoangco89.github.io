<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Translate & Speak</title>
</head>
<body>

<h3>Chọn giọng đọc:</h3>
<select id="voiceSelect"></select>

<h3>Nhập văn bản:</h3>
<div id="inputText">How are you?</div>

<h3>Văn bản đã dịch:</h3>
<div id="translatedText" style="font-size:20px; margin-top:10px; color:blue;"></div>

<script>
// API dịch MyMemory
async function translateText(text, targetLang) {
    const langCode = targetLang.split("-")[0];
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${langCode}`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        return data.responseData.translatedText || text;
    } catch {
        return text;
    }
}

// Tải danh sách voice
function loadVoices() {
    const voices = speechSynthesis.getVoices();
    const select = document.getElementById("voiceSelect");

    select.innerHTML = "";

    voices.forEach((v, i) => {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = `${v.name} (${v.lang})`;
        select.appendChild(option);
    });

    // Khôi phục voice mặc định
    const saved = localStorage.getItem("defaultVoiceIndex");
    if (saved && voices[saved]) {
        select.value = saved;
    }
}

// Hàm đọc văn bản (dùng lại cho mọi trường hợp)
async function translateAndSpeak() {
    const voices = speechSynthesis.getVoices();
    const index = document.getElementById("voiceSelect").value;
    const selectedVoice = voices[index];

    const text = document.getElementById("inputText").textContent;

    // Dịch
    const translated = await translateText(text, selectedVoice.lang);

    // Hiển thị bản dịch
    document.getElementById("translatedText").textContent = translated;

    // Đọc
    const utter = new SpeechSynthesisUtterance(translated);
    utter.voice = selectedVoice;
    
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
}

// Khi chọn voice → lưu + dịch + đọc
document.getElementById("voiceSelect").addEventListener("change", () => {
    const index = document.getElementById("voiceSelect").value;
    localStorage.setItem("defaultVoiceIndex", index);
    translateAndSpeak();
});

// Khi văn bản thay đổi → auto dịch + auto đọc
document.getElementById("inputText").addEventListener("input", () => {
    translateAndSpeak();
});

// Chờ voice load
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();
</script>

</body>
</html>